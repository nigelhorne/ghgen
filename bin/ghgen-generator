#!/usr/bin/env perl
use v5.36;
use warnings;
use YAML::XS qw(Dump);
use Path::Tiny;
use Getopt::Long;
use Term::ANSIColor qw(colored);

my $project_type;
my $output_file;
my $list_types;
my $interactive;

GetOptions(
    'type=s'     => \$project_type,
    'output=s'   => \$output_file,
    'list'       => \$list_types,
    'interactive' => \$interactive,
) or die "Usage: $0 --type=<type> [--output=<file>] [--list] [--interactive]\n";

if ($list_types) {
    list_available_types();
    exit 0;
}

# Interactive mode
if ($interactive || !$project_type) {
    $project_type = interactive_select_type();
}

die "Please specify a project type with --type or use --interactive\n" unless $project_type;

my $workflow = generate_workflow($project_type);

unless ($workflow) {
    die colored(['red'], "Error: ") . "Unknown project type '$project_type'\n" .
        "Run with --list to see available types.\n";
}

# Determine output location
unless ($output_file) {
    my $workflows_dir = path('.github/workflows');
    $workflows_dir->mkpath unless $workflows_dir->exists;
    $output_file = $workflows_dir->child("$project_type-ci.yml");
}

# Write the workflow
my $yaml = Dump($workflow);
path($output_file)->spew_utf8($yaml);

say colored(['green'], "âœ“ ") . "Generated workflow: " . colored(['bold'], $output_file);
say "";
say colored(['cyan'], "Next steps:");
say "  1. Review the generated workflow";
say "  2. Customize it for your project";
say "  3. Commit and push to trigger the workflow";
say "";
say colored(['yellow'], "ðŸ’¡ Tip: ") . "Run '../ghgen-analyze' to check for additional optimizations";

exit 0;

# ============================================================================
# Workflow Templates
# ============================================================================

sub generate_workflow($type) {
    my %generators = (
        node     => \&generate_node_workflow,
        python   => \&generate_python_workflow,
        rust     => \&generate_rust_workflow,
        go       => \&generate_go_workflow,
        ruby     => \&generate_ruby_workflow,
        perl     => \&generate_perl_workflow,
        docker   => \&generate_docker_workflow,
        static   => \&generate_static_workflow,
    );
    
    return undef unless exists $generators{$type};
    return $generators{$type}->();
}

sub generate_node_workflow() {
    return {
        name => 'Node.js CI',
        on => {
            push => {
                branches => ['main', 'develop'],
            },
            pull_request => {
                branches => ['main', 'develop'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => 'true',
        },
        jobs => {
            test => {
                'runs-on' => 'ubuntu-latest',
                strategy => {
                    matrix => {
                        'node-version' => ['18.x', '20.x', '22.x'],
                    },
                },
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Setup Node.js ${{ matrix.node-version }}',
                        uses => 'actions/setup-node@v4',
                        with => {
                            'node-version' => '${{ matrix.node-version }}',
                        },
                    },
                    {
                        name => 'Cache dependencies',
                        uses => 'actions/cache@v4',
                        with => {
                            path => '~/.npm',
                            key => '${{ runner.os }}-node-${{ hashFiles(\'**/package-lock.json\') }}',
                            'restore-keys' => '${{ runner.os }}-node-',
                        },
                    },
                    {
                        name => 'Install dependencies',
                        run => 'npm ci',
                    },
                    {
                        name => 'Run linter',
                        run => 'npm run lint --if-present',
                    },
                    {
                        name => 'Run tests',
                        run => 'npm test',
                    },
                    {
                        name => 'Build project',
                        run => 'npm run build --if-present',
                    },
                ],
            },
        },
    };
}

sub generate_python_workflow() {
    return {
        name => 'Python CI',
        on => {
            push => {
                branches => ['main', 'develop'],
            },
            pull_request => {
                branches => ['main', 'develop'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => \1,
        },
        jobs => {
            test => {
                'runs-on' => 'ubuntu-latest',
                strategy => {
                    matrix => {
                        'python-version' => ['3.9', '3.10', '3.11', '3.12'],
                    },
                },
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Set up Python ${{ matrix.python-version }}',
                        uses => 'actions/setup-python@v5',
                        with => {
                            'python-version' => '${{ matrix.python-version }}',
                        },
                    },
                    {
                        name => 'Cache pip packages',
                        uses => 'actions/cache@v4',
                        with => {
                            path => '~/.cache/pip',
                            key => '${{ runner.os }}-pip-${{ hashFiles(\'**/requirements.txt\') }}',
                            'restore-keys' => '${{ runner.os }}-pip-',
                        },
                    },
                    {
                        name => 'Install dependencies',
                        run => "pip install -r requirements.txt\npip install pytest pytest-cov flake8",
                    },
                    {
                        name => 'Lint with flake8',
                        run => 'flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics',
                    },
                    {
                        name => 'Run tests with coverage',
                        run => 'pytest --cov=. --cov-report=xml',
                    },
                ],
            },
        },
    };
}

sub generate_rust_workflow() {
    return {
        name => 'Rust CI',
        on => {
            push => {
                branches => ['main'],
            },
            pull_request => {
                branches => ['main'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => \1,
        },
        jobs => {
            test => {
                'runs-on' => 'ubuntu-latest',
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Setup Rust',
                        uses => 'dtolnay/rust-toolchain@stable',
                    },
                    {
                        name => 'Cache cargo registry',
                        uses => 'actions/cache@v4',
                        with => {
                            path => "~/.cargo/bin/\n~/.cargo/registry/index/\n~/.cargo/registry/cache/\n~/.cargo/git/db/\ntarget/",
                            key => '${{ runner.os }}-cargo-${{ hashFiles(\'**/Cargo.lock\') }}',
                        },
                    },
                    {
                        name => 'Check formatting',
                        run => 'cargo fmt -- --check',
                    },
                    {
                        name => 'Run clippy',
                        run => 'cargo clippy -- -D warnings',
                    },
                    {
                        name => 'Run tests',
                        run => 'cargo test --verbose',
                    },
                    {
                        name => 'Build release',
                        run => 'cargo build --release --verbose',
                    },
                ],
            },
        },
    };
}

sub generate_go_workflow() {
    return {
        name => 'Go CI',
        on => {
            push => {
                branches => ['main'],
            },
            pull_request => {
                branches => ['main'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => \1,
        },
        jobs => {
            test => {
                'runs-on' => 'ubuntu-latest',
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Setup Go',
                        uses => 'actions/setup-go@v5',
                        with => {
                            'go-version' => '1.22',
                        },
                    },
                    {
                        name => 'Cache Go modules',
                        uses => 'actions/cache@v4',
                        with => {
                            path => '~/go/pkg/mod',
                            key => '${{ runner.os }}-go-${{ hashFiles(\'**/go.sum\') }}',
                            'restore-keys' => '${{ runner.os }}-go-',
                        },
                    },
                    {
                        name => 'Download dependencies',
                        run => 'go mod download',
                    },
                    {
                        name => 'Run go vet',
                        run => 'go vet ./...',
                    },
                    {
                        name => 'Run tests',
                        run => 'go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...',
                    },
                    {
                        name => 'Build',
                        run => 'go build -v ./...',
                    },
                ],
            },
        },
    };
}

sub generate_ruby_workflow() {
    return {
        name => 'Ruby CI',
        on => {
            push => {
                branches => ['main'],
            },
            pull_request => {
                branches => ['main'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => \1,
        },
        jobs => {
            test => {
                'runs-on' => 'ubuntu-latest',
                strategy => {
                    matrix => {
                        'ruby-version' => ['3.1', '3.2', '3.3'],
                    },
                },
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Set up Ruby',
                        uses => 'ruby/setup-ruby@v1',
                        with => {
                            'ruby-version' => '${{ matrix.ruby-version }}',
                            'bundler-cache' => 'true',
                        },
                    },
                    {
                        name => 'Run tests',
                        run => 'bundle exec rake test',
                    },
                ],
            },
        },
    };
}

sub generate_perl_workflow() {
    return {
        name => 'Perl CI',
        on => {
            push => {
                branches => ['main', 'master'],
            },
            pull_request => {
                branches => ['main', 'master'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => 'true',
        },
        jobs => {
            test => {
                'runs-on' => 'ubuntu-latest',
                strategy => {
                    matrix => {
                        'perl-version' => ['5.36', '5.38', '5.40'],
                    },
                },
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Set up Perl',
                        uses => 'shogo82148/actions-setup-perl@v1',
                        with => {
                            'perl-version' => '${{ matrix.perl-version }}',
                        },
                    },
                    {
                        name => 'Cache CPAN modules',
                        uses => 'actions/cache@v4',
                        with => {
                            path => '~/perl5',
                            key => join('', 
                                '${{ runner.os }}-perl-',
                                '${{ matrix.perl-version }}-',
                                '${{ hashFiles(\'cpanfile\') }}'
                            ),
                            'restore-keys' => join("\n",
                                '${{ runner.os }}-perl-${{ matrix.perl-version }}-',
                                '${{ runner.os }}-perl-'
                            ),
                        },
                    },
                    {
                        name => 'Install cpanm and local::lib',
                        run => join("\n",
                            'curl -L https://cpanmin.us | \\',
                            '  perl - --notest App::cpanminus local::lib'
                        ),
                    },
                    {
                        name => 'Install dependencies',
                        run => join("\n",
                            'eval $(perl -I ~/perl5/lib/perl5 -Mlocal::lib)',
                            'cpanm --notest --installdeps .'
                        ),
                    },
                    {
                        name => 'Run Perl::Critic',
                        run => join("\n",
                            'eval $(perl -I ~/perl5/lib/perl5 -Mlocal::lib)',
                            'cpanm --notest Perl::Critic',
                            'perlcritic --severity 3 lib/ || true'
                        ),
                        'continue-on-error' => 'true',
                    },
                    {
                        name => 'Run tests',
                        run => join("\n",
                            'eval $(perl -I ~/perl5/lib/perl5 -Mlocal::lib)',
                            'prove -lr t/'
                        ),
                    },
                    {
                        name => 'Test coverage',
                        if => 'matrix.perl-version == \'5.40\'',
                        run => join("\n",
                            'eval $(perl -I ~/perl5/lib/perl5 -Mlocal::lib)',
                            'cpanm --notest Devel::Cover',
                            'cover -delete',
                            'HARNESS_PERL_SWITCHES=-MDevel::Cover prove -lr t/',
                            'cover'
                        ),
                    },
                ],
            },
        },
    };
}

sub generate_docker_workflow() {
    return {
        name => 'Docker Build',
        on => {
            push => {
                branches => ['main'],
                tags => ['v*'],
            },
            pull_request => {
                branches => ['main'],
            },
        },
        concurrency => {
            group => '${{ github.workflow }}-${{ github.ref }}',
            'cancel-in-progress' => \1,
        },
        jobs => {
            build => {
                'runs-on' => 'ubuntu-latest',
                steps => [
                    {
                        name => 'Checkout code',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Set up Docker Buildx',
                        uses => 'docker/setup-buildx-action@v3',
                    },
                    {
                        name => 'Log in to Docker Hub',
                        uses => 'docker/login-action@v3',
                        with => {
                            username => '${{ secrets.DOCKER_USERNAME }}',
                            password => '${{ secrets.DOCKER_PASSWORD }}',
                        },
                        if => 'github.event_name != \'pull_request\'',
                    },
                    {
                        name => 'Extract metadata',
                        id => 'meta',
                        uses => 'docker/metadata-action@v5',
                        with => {
                            images => 'your-username/your-image',
                        },
                    },
                    {
                        name => 'Build and push',
                        uses => 'docker/build-push-action@v5',
                        with => {
                            context => '.',
                            push => '${{ github.event_name != \'pull_request\' }}',
                            tags => '${{ steps.meta.outputs.tags }}',
                            labels => '${{ steps.meta.outputs.labels }}',
                            'cache-from' => 'type=gha',
                            'cache-to' => 'type=gha,mode=max',
                        },
                    },
                ],
            },
        },
    };
}

sub generate_static_workflow() {
    return {
        name => 'Deploy Static Site',
        on => {
            push => {
                branches => ['main'],
            },
        },
        permissions => {
            contents => 'read',
            pages => 'write',
            'id-token' => 'write',
        },
        concurrency => {
            group => 'pages',
            'cancel-in-progress' => 'false',
        },
        jobs => {
            build => {
                'runs-on' => 'ubuntu-latest',
                steps => [
                    {
                        name => 'Checkout',
                        uses => 'actions/checkout@v4',
                    },
                    {
                        name => 'Setup Pages',
                        uses => 'actions/configure-pages@v4',
                    },
                    {
                        name => 'Build',
                        run => 'echo "Add your build command here"',
                    },
                    {
                        name => 'Upload artifact',
                        uses => 'actions/upload-pages-artifact@v3',
                        with => {
                            path => './public',
                        },
                    },
                ],
            },
            deploy => {
                environment => {
                    name => 'github-pages',
                    url => '${{ steps.deployment.outputs.page_url }}',
                },
                'runs-on' => 'ubuntu-latest',
                needs => 'build',
                steps => [
                    {
                        name => 'Deploy to GitHub Pages',
                        id => 'deployment',
                        uses => 'actions/deploy-pages@v4',
                    },
                ],
            },
        },
    };
}

# ============================================================================
# Helper Functions
# ============================================================================

sub list_available_types() {
    say colored(['bold cyan'], "Available workflow templates:");
    say "";
    
    my @types = (
        ['node',    'Node.js/npm projects with testing and linting'],
        ['python',  'Python projects with pytest and coverage'],
        ['rust',    'Rust projects with cargo, clippy, and formatting'],
        ['go',      'Go projects with testing and race detection'],
        ['ruby',    'Ruby projects with bundler and rake'],
        ['perl',    'Perl projects with cpanm, prove, and coverage'],
        ['docker',  'Docker image build and push workflow'],
        ['static',  'Static site deployment to GitHub Pages'],
    );
    
    for my $type (@types) {
        say "  " . colored(['green'], sprintf("%-10s", $type->[0])) . " - $type->[1]";
    }
    
    say "";
    say "Usage: $0 --type=<type> [--output=<file>]";
    say "   or: $0 --interactive";
}

sub interactive_select_type() {
    say colored(['bold cyan'], "GitHub Actions Workflow Generator");
    say colored(['cyan'], "=" x 50);
    say "";
    say "Select a project type:";
    say "";
    
    my @types = qw(node python rust go ruby perl docker static);
    my %descriptions = (
        node   => 'Node.js/npm',
        python => 'Python',
        rust   => 'Rust',
        go     => 'Go',
        ruby   => 'Ruby',
        perl   => 'Perl',
        docker => 'Docker',
        static => 'Static site (GitHub Pages)',
    );
    
    for my $i (0..$#types) {
        say "  " . colored(['green'], $i + 1) . ". $descriptions{$types[$i]}";
    }
    
    say "";
    print "Enter number (1-" . scalar(@types) . "): ";
    chomp(my $choice = <STDIN>);
    
    if ($choice =~ /^\d+$/ && $choice >= 1 && $choice <= @types) {
        return $types[$choice - 1];
    }
    
    die colored(['red'], "Invalid choice\n");
}
